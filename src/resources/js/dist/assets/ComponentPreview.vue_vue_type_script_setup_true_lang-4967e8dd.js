var q=Object.defineProperty;var U=(i,e,t)=>e in i?q(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var y=(i,e,t)=>(U(i,typeof e!="symbol"?e+"":e,t),t);import{s as z,b as D,l as j,t as C}from"./helpers-38280ba3.js";import{e as F}from"./ResourceService-bb2bf1b5.js";import{d as N,i as I,k as G,M as W,O as J,o as O,c as B,a as K,A as Q,f as X}from"./index-da8990b5.js";const{resourceFromId:Y}=F(),k=i=>typeof i=="string"?i==null?void 0:i.toString():"",Z=i=>{var e;return(typeof i=="number"||typeof i=="string")&&((e=Y(+i))==null?void 0:e.url)||""},ee=i=>{if(typeof i!="number"||typeof i!="string"){const e=i;return e.rows.reduce((t,r)=>{const n=e.columns.reduce((d,c)=>{const o=r.find(f=>f.name===c.name),m=(o==null?void 0:o.value)||(o==null?void 0:o.default),p=!(o!=null&&o.type)||!m?null:V(o==null?void 0:o.type,m);return d[c.name]=p,d},{});return[...t,n]},[])}return[]},V=(i,e)=>{switch(i){case"text":return k(e);case"resource":return Z(e);case"datatable":return ee(e);case"textarea":return k(e);default:return""}},M=(i,e)=>i.variables.reduce((r,n)=>{var o;const d=e&&e[n.name]?e[n.name]:(o=i.variables.find(m=>m.name===n.name))==null?void 0:o.default,c=d?V(n.type,d):"";return r[n.name]=c,r},{});class te{constructor(){y(this,"component");y(this,"subscribedComponents",{})}subscribe(e,t){e.id&&(this.subscribedComponents[e.id]=t)}attach(e){this.component=e}detach(){this.component=void 0}update(){var e,t,r;this.component&&this.component.id&&((r=(t=this.subscribedComponents)[this.component.id])==null||r.call(t,M(this.component,(e=this.component)==null?void 0:e.content)||{}))}}const ne=new te,ie=()=>ne,oe=["div","a","p","h1","img"];class se{constructor(){y(this,"htmlString");y(this,"document")}setHtmlString(e){this.htmlString=e}getElements(){return oe.map(e=>Array.from(this.document.getElementsByTagName(e))).flat()}compose(){const t=new DOMParser().parseFromString(this.htmlString,"text/html");return this.document=t,this.getElements().forEach(n=>{n.dataset.simplisitiid||(n.dataset.simplisitiid=Math.random().toString(36).substring(7))}),this}clearHtmlString(){let e=this.document.body.innerHTML;return e=e.replaceAll('draggable="true"',""),e}async getComposedHtmlString(){return new Promise(e=>{setTimeout(()=>{e(this.clearHtmlString())},100)})}updateClassOfElementBySimplisitiId(e,t){const r=this.document.querySelector(`[data-simplisitiid="${e}"]`);r!==null&&(r.classList.forEach(n=>{setTimeout(()=>{n.startsWith("sp-style")&&r.classList.remove(n)},100)}),t.forEach(n=>{setTimeout(()=>{r.classList.add(n)},100)}))}updateStyleOfElementBySimplisitiId(e,t){const r=this.document.querySelector(`[data-simplisitiid="${e}"]`);if(r!==null)for(const n in t)setTimeout(()=>{r.style.setProperty(n,t[n])},100)}updateContainerContentBySimplisitiId(e,t){if(e==="simplisiti-component-preview"){this.document.body.innerHTML=t;return}const r=this.document.querySelector(`[data-simplisitiid="${e}"]`);r!==null&&(r.innerHTML=t)}updateAttributeOfElementBySimplisitiId(e,t){const r=this.document.querySelector(`[data-simplisitiid="${e}"]`);r!==null&&setTimeout(()=>{r.setAttribute(t.type,t.content)},100)}removeElementBySimplisitiId(e){const t=this.document.querySelector(`[data-simplisitiid="${e}"]`);t!==null&&t.remove()}}const re={class:"relative"},ae={key:0,class:"absolute inset-0"},pe=N({__name:"ComponentPreview",props:{component:{type:Object,required:!0},html:{type:[String,null],default:null},allowEdit:{type:Boolean,default:!1},lazy:{type:Boolean,default:!1}},emits:["update"],setup(i,{emit:e}){const t=ie(),r=I(!1),n=new se,d=i,c=e,o=I(null),m=()=>{const s=document.createElement("script"),a=document.createElement("link"),l=document.createElement("link"),g=document.createElement("script"),v=document.createElement("script"),E=C("script"),w=C("style"),u=C("layout"),h="https://unpkg.com/vue@3/dist/vue.global.js";return a.rel="stylesheet",a.href=w,l.rel="stylesheet",l.href=u,g.src=h,s.src=E,v.innerHTML=`
        const appContainer = document.createElement('div');
        appContainer.id = 'simplisiti-component-editor-app';
        appContainer.innerHTML = '<simplisiti-component-editor/>';
        document.body.appendChild(appContainer);
        window.addEventListener('load', () => {
            const { createApp } = Vue;
            const app = createApp({});
            app.use(SimplisitiComponentEditor);
            app.mount('#simplisiti-component-editor-app');
        });
    `,[a,s,g,v,l]},p=async()=>{if(!d.component.id)return;n.setHtmlString(d.html||d.component.html);let s=d.component.html;if(d.lazy){const l=M(d.component,d.component.content);s=(await z(d.component.id,l)).data}else s=await n.compose().getComposedHtmlString();const a=document.createElement("div");if(a.dataset.simplisitiid="simplisiti-component-preview",a.innerHTML=s,o.value){const l=o.value.contentDocument;if(!l)return;const[g,v]=await D(),[E,w]=await j(),u=l.createElement("meta");if(u.name="viewport",u.content="width=device-width, initial-scale=1.0",l.open(),l.write(a.outerHTML),l.head.appendChild(u),l.head.appendChild(g),l.head.appendChild(E),l.body.appendChild(v),l.body.appendChild(w),d.allowEdit){const[h,R,_,P,$]=m();l.head.appendChild(h),l.head.appendChild($),l.body.appendChild(_),l.body.appendChild(R),l.body.appendChild(P)}l.close(),o.value.onload=()=>{const h=l.body.scrollHeight;d.allowEdit||(o.value&&(o.value.style.height=`${h}px`),r.value=!0)}}},f=async s=>{n.updateClassOfElementBySimplisitiId(s.detail.simplisitiId,s.detail.spClassList);const a=await n.getComposedHtmlString();c("update",a)},b=async s=>{n.updateStyleOfElementBySimplisitiId(s.detail.simplisitiId,s.detail.spStyleList);const a=await n.getComposedHtmlString();c("update",a)},S=async s=>{n.removeElementBySimplisitiId(s.detail.simplisitiId);const a=await n.getComposedHtmlString();c("update",a)},L=async s=>{n.updateContainerContentBySimplisitiId(s.detail.simplisitiId,s.detail.content);const a=await n.getComposedHtmlString();c("update",a)},H=async s=>{n.updateAttributeOfElementBySimplisitiId(s.detail.simplisitiId,s.detail.attribute);const a=await n.getComposedHtmlString();c("update",a)},A=()=>{if(o.value){const s=o.value.contentDocument;if(!s)return;const a=s.body.offsetHeight;o.value.style.height=`${a}px`}},x=()=>{d.allowEdit&&(window.document.addEventListener("classChange",f),window.document.addEventListener("styleChange",b),window.document.addEventListener("contentChange",L),window.document.addEventListener("elementRemoved",S),window.document.addEventListener("attributeChange",H))},T=new IntersectionObserver(s=>{for(let a of s)a.isIntersecting&&!r.value&&setTimeout(()=>{p()},100)});return G(()=>{o.value&&!d.allowEdit&&T.observe(o.value),x(),d.allowEdit?p():d.html||t.subscribe(d.component,()=>{p().then(()=>A())})}),W(()=>{o.value&&T.unobserve(o.value)}),J(()=>{window.document.removeEventListener("classChange",f),window.document.removeEventListener("styleChange",b),window.document.removeEventListener("contentChange",L),window.document.removeEventListener("elementRemoved",S),window.document.removeEventListener("attributeChange",H)}),(s,a)=>(O(),B("div",re,[K("iframe",{class:Q(["w-full",{"h-full":i.allowEdit}]),ref_key:"iframe",ref:o,sandbox:"allow-scripts allow-same-origin",loading:"lazy"},null,2),i.allowEdit?X("",!0):(O(),B("div",ae))]))}});export{pe as _,ie as u};
