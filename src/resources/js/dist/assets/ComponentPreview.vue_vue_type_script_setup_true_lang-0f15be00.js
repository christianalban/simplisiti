var j=Object.defineProperty;var N=(o,e,n)=>e in o?j(o,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):o[e]=n;var y=(o,e,n)=>(N(o,typeof e!="symbol"?e+"":e,n),n);import{e as F,f as C,h as O,i as B}from"./PageService-5e90f161.js";import{u as G}from"./ResourceService-d521b846.js";import{d as W,e as V,g as J,N as K,O as Q,o as U,c as A,h as X,A as Y,l as Z}from"./index-c5c10336.js";const{resourceFromId:ee}=G(),M=o=>typeof o=="string"?o==null?void 0:o.toString():"",te=o=>{var e;return(typeof o=="number"||typeof o=="string")&&((e=ee(+o))==null?void 0:e.url)||""},ne=o=>{if(typeof o!="number"||typeof o!="string"){const e=o;return e.rows.reduce((n,l)=>{const i=e.columns.reduce((c,d)=>{const r=l.find(v=>v.name===d.name),u=(r==null?void 0:r.value)||(r==null?void 0:r.default),g=!(r!=null&&r.type)||!u?null:P(r==null?void 0:r.type,u);return c[d.name]=g,c},{});return[...n,i]},[])}return[]},P=(o,e)=>{switch(o){case"text":return M(e);case"resource":return te(e);case"datatable":return ne(e);case"textarea":return M(e);default:return""}},R=(o,e)=>o.variables.reduce((l,i)=>{var r;const c=e&&e[i.name]?e[i.name]:(r=o.variables.find(u=>u.name===i.name))==null?void 0:r.default,d=c?P(i.type,c):"";return l[i.name]=d,l},{});class ie{constructor(){y(this,"component");y(this,"subscribedComponents",{})}subscribe(e,n){e.id&&(this.subscribedComponents[e.id]=n)}attach(e){this.component=e}detach(){this.component=void 0}update(){var e,n,l;this.component&&this.component.id&&((l=(n=this.subscribedComponents)[this.component.id])==null||l.call(n,R(this.component,(e=this.component)==null?void 0:e.content)||{}))}}const se=new ie,oe=()=>se,re=["div","a","p","h1","img"];class ae{constructor(){y(this,"htmlString");y(this,"document")}setHtmlString(e){this.htmlString=e}getElements(){return re.map(e=>Array.from(this.document.getElementsByTagName(e))).flat()}compose(){const n=new DOMParser().parseFromString(this.htmlString,"text/html");return this.document=n,this.getElements().forEach(i=>{i.dataset.simplisitiid||(i.dataset.simplisitiid=Math.random().toString(36).substring(7))}),this}clearHtmlString(){let e=this.document.body.innerHTML;return e=e.replaceAll('draggable="true"',""),e}async getComposedHtmlString(){return new Promise(e=>{setTimeout(()=>{e(this.clearHtmlString())},100)})}updateClassOfElementBySimplisitiId(e,n){const l=this.document.querySelector(`[data-simplisitiid="${e}"]`);l!==null&&(l.classList.forEach(i=>{setTimeout(()=>{i.startsWith("sp-style")&&l.classList.remove(i)},100)}),n.forEach(i=>{setTimeout(()=>{l.classList.add(i)},100)}))}updateStyleOfElementBySimplisitiId(e,n){const l=this.document.querySelector(`[data-simplisitiid="${e}"]`);if(l!==null)for(const i in n)setTimeout(()=>{l.style.setProperty(i,n[i])},100)}updateContainerContentBySimplisitiId(e,n){if(e==="simplisiti-component-preview"){this.document.body.innerHTML=n;return}const l=this.document.querySelector(`[data-simplisitiid="${e}"]`);l!==null&&(l.innerHTML=n)}updateAttributeOfElementBySimplisitiId(e,n){const l=this.document.querySelector(`[data-simplisitiid="${e}"]`);l!==null&&setTimeout(()=>{l.setAttribute(n.type,n.content)},100)}removeElementBySimplisitiId(e){const n=this.document.querySelector(`[data-simplisitiid="${e}"]`);n!==null&&n.remove()}}const le={class:"relative"},ce={key:0,class:"absolute inset-0"},he=W({__name:"ComponentPreview",props:{component:{type:Object,required:!0},html:{type:[String,null],default:null},allowEdit:{type:Boolean,default:!1},lazy:{type:Boolean,default:!1}},emits:["update"],setup(o,{emit:e}){const n=oe(),l=V(!1),i=new ae,c=o,d=e,r=V(null),u=()=>{const t=document.createElement("script"),s=document.createElement("link"),a=document.createElement("link"),m=document.createElement("script"),f=document.createElement("script"),E=C("script"),w=C("style"),p=C("layout"),h="https://unpkg.com/vue@3/dist/vue.global.js";return s.rel="stylesheet",s.href=w,a.rel="stylesheet",a.href=p,m.src=h,t.src=E,f.innerHTML=`
        const appContainer = document.createElement('div');
        appContainer.id = 'simplisiti-component-editor-app';
        appContainer.innerHTML = '<simplisiti-component-editor/>';
        document.body.appendChild(appContainer);
        window.addEventListener('load', () => {
            const { createApp } = Vue;
            const app = createApp({});
            app.use(SimplisitiComponentEditor);
            app.mount('#simplisiti-component-editor-app');
        });
    `,[s,t,m,f,a]},g=()=>{const t=document.createElement("link"),s=document.createElement("script"),a=O("style"),m=O("script");return t.rel="stylesheet",t.href=a,s.src=m,s.async=!0,[t,s]},v=()=>{const t=document.createElement("link"),s=document.createElement("script"),a=B("style"),m=B("script");return t.rel="stylesheet",t.href=a,s.src=m,s.async=!0,[t,s]},b=async()=>{if(!c.component.id)return;i.setHtmlString(c.html||c.component.html);let t=c.component.html;if(c.lazy){const a=R(c.component,c.component.content);t=(await F(c.component.id,a)).data}else t=await i.compose().getComposedHtmlString();const s=document.createElement("div");if(s.dataset.simplisitiid="simplisiti-component-preview",s.innerHTML=t,r.value){const a=r.value.contentDocument;if(!a)return;const[m,f]=g(),[E,w]=v(),p=a.createElement("meta");if(p.name="viewport",p.content="width=device-width, initial-scale=1.0",a.open(),a.write(s.outerHTML),a.head.appendChild(p),a.head.appendChild(m),a.head.appendChild(E),a.body.appendChild(f),a.body.appendChild(w),c.allowEdit){const[h,$,q,z,D]=u();a.head.appendChild(h),a.head.appendChild(D),a.body.appendChild(q),a.body.appendChild($),a.body.appendChild(z)}a.close(),r.value.onload=()=>{const h=a.body.scrollHeight;c.allowEdit||(r.value&&(r.value.style.height=`${h}px`),l.value=!0)}}},S=async t=>{i.updateClassOfElementBySimplisitiId(t.detail.simplisitiId,t.detail.spClassList);const s=await i.getComposedHtmlString();d("update",s)},L=async t=>{i.updateStyleOfElementBySimplisitiId(t.detail.simplisitiId,t.detail.spStyleList);const s=await i.getComposedHtmlString();d("update",s)},H=async t=>{i.removeElementBySimplisitiId(t.detail.simplisitiId);const s=await i.getComposedHtmlString();d("update",s)},T=async t=>{i.updateContainerContentBySimplisitiId(t.detail.simplisitiId,t.detail.content);const s=await i.getComposedHtmlString();d("update",s)},k=async t=>{i.updateAttributeOfElementBySimplisitiId(t.detail.simplisitiId,t.detail.attribute);const s=await i.getComposedHtmlString();d("update",s)},x=()=>{if(r.value){const t=r.value.contentDocument;if(!t)return;const s=t.body.offsetHeight;r.value.style.height=`${s}px`}},_=()=>{c.allowEdit&&(window.document.addEventListener("classChange",S),window.document.addEventListener("styleChange",L),window.document.addEventListener("contentChange",T),window.document.addEventListener("elementRemoved",H),window.document.addEventListener("attributeChange",k))},I=new IntersectionObserver(t=>{for(let s of t)s.isIntersecting&&!l.value&&setTimeout(()=>{b()},100)});return J(()=>{r.value&&!c.allowEdit&&I.observe(r.value),_(),c.html||n.subscribe(c.component,()=>{b().then(()=>x())})}),K(()=>{r.value&&I.unobserve(r.value)}),Q(()=>{window.document.removeEventListener("classChange",S),window.document.removeEventListener("styleChange",L),window.document.removeEventListener("contentChange",T),window.document.removeEventListener("elementRemoved",H),window.document.removeEventListener("attributeChange",k)}),(t,s)=>(U(),A("div",le,[X("iframe",{class:Y(["w-full",{"h-full":o.allowEdit}]),ref_key:"iframe",ref:r,sandbox:"allow-scripts allow-same-origin",loading:"lazy"},null,2),o.allowEdit?Z("",!0):(U(),A("div",ce))]))}});export{he as _,oe as u};
